-- Configuration table for flat file ingestion metadata - Universal schema (Warehouse version)

DROP TABLE IF EXISTS config.config_flat_file_ingestion;

CREATE TABLE config.config_flat_file_ingestion (
    config_group_id NVARCHAR(100) NULL, -- logical grouping for file groups
    config_id NVARCHAR(50) NOT NULL, -- specific file config
    source_file_path NVARCHAR(500) NOT NULL,
    source_file_format NVARCHAR(20) NOT NULL, -- csv, json, parquet, avro, xml
    -- Source location fields (optional - defaults to target or raw workspace)
    source_workspace_id NVARCHAR(50) NULL, -- Source workspace ID (legacy)
    source_datastore_id NVARCHAR(50) NULL, -- Source lakehouse/warehouse ID (legacy)
    source_workspace_name NVARCHAR(200) NULL, -- Source workspace name (preferred)
    source_datastore_name NVARCHAR(200) NULL, -- Source lakehouse/warehouse name (preferred)
    source_datastore_type NVARCHAR(20) NULL, -- 'lakehouse' or 'warehouse' (defaults to lakehouse)
    source_file_root_path NVARCHAR(200) NULL, -- Root path override (e.g., "Files", "Tables")
    -- Target location fields
    target_workspace_id NVARCHAR(50) NULL, -- Target workspace ID (legacy)
    target_datastore_id NVARCHAR(50) NULL, -- Target lakehouse/warehouse ID (legacy)
    target_workspace_name NVARCHAR(200) NULL, -- Target workspace name (preferred)
    target_datastore_name NVARCHAR(200) NULL, -- Target lakehouse/warehouse name (preferred)
    target_datastore_type NVARCHAR(20) NOT NULL, -- 'lakehouse' or 'warehouse'
    target_schema_name NVARCHAR(50) NOT NULL,
    target_table_name NVARCHAR(100) NOT NULL,
    staging_table_name NVARCHAR(100) NULL, -- For warehouse COPY INTO staging
    file_delimiter NVARCHAR(5) NULL, -- for CSV files
    has_header BIT NULL, -- for CSV files
    encoding NVARCHAR(20) NULL, -- utf-8, latin-1, etc.
    date_format NVARCHAR(50) NULL, -- for date columns
    timestamp_format NVARCHAR(50) NULL, -- for timestamp columns
    schema_inference BIT NOT NULL, -- whether to infer schema
    -- Advanced CSV handling options
    quote_character NVARCHAR(2) NULL, -- character used to quote fields (default: ")
    escape_character NVARCHAR(2) NULL, -- character used to escape quotes (default: \)
    multiline_values BIT NULL, -- allow newlines within quoted fields (default: TRUE)
    ignore_leading_whitespace BIT NULL, -- trim leading whitespace (default: FALSE)
    ignore_trailing_whitespace BIT NULL, -- trim trailing whitespace (default: FALSE)
    null_value NVARCHAR(50) NULL, -- custom null value representation
    empty_value NVARCHAR(50) NULL, -- custom empty value representation
    comment_character NVARCHAR(2) NULL, -- character that starts comment lines
    max_columns INT NULL, -- maximum number of columns allowed
    max_chars_per_column INT NULL, -- maximum characters per column (-1 for unlimited)
    custom_schema_json NVARCHAR(MAX) NULL, -- custom schema definition
    partition_columns NVARCHAR(500) NULL, -- comma-separated list
    sort_columns NVARCHAR(500) NULL, -- comma-separated list
    write_mode NVARCHAR(20) NOT NULL, -- overwrite, append, merge
    merge_keys NVARCHAR(500) NULL, -- for merge operations
    enable_schema_evolution BIT NULL, -- enable schema evolution
    execution_group INT NOT NULL DEFAULT 1, -- execution order (same = parallel, different = sequential)
    active_yn NVARCHAR(1) NOT NULL,
    created_date NVARCHAR(50) NOT NULL,
    modified_date NVARCHAR(50) NULL,
    created_by NVARCHAR(100) NOT NULL,
    modified_by NVARCHAR(100) NULL,
    -- Discovery and Import Configuration (Simplified Schema)
    import_pattern NVARCHAR(50) NULL, -- 'single_file', 'incremental_files', 'incremental_folders'
    discovery_pattern NVARCHAR(200) NULL, -- Glob pattern: "*.csv", "batch_*", "*/*/*"
    date_pattern NVARCHAR(50) NULL, -- 'YYYYMMDD', 'YYYY-MM-DD', 'YYYY/MM/DD', 'DD-MM-YYYY'
    date_range_start NVARCHAR(50) NULL, -- Start date for filtering
    date_range_end NVARCHAR(50) NULL, -- End date for filtering
    duplicate_handling NVARCHAR(20) NULL, -- 'skip', 'allow', 'fail' (default: 'skip')
    require_files BIT NULL, -- If True, fail config when no files are found (default: False)
    data_validation_rules NVARCHAR(MAX) NULL, -- JSON validation rules

    CONSTRAINT PK_config_flat_file_ingestion PRIMARY KEY (config_id)
);