{%- import 'shared/notebook/macros/notebook_macros.py.jinja' as macros -%}
{%- include "shared/notebook/headers/pyspark.py.jinja" %}

{% include "shared/notebook/environment/library_loader.py.jinja" %}

{{macros.python_cell_with_heading("## ğŸ—‚ï¸ Load Custom Python Libraries")}}

if run_mode == "local":
    from ingen_fab.python_libs.common.config_utils import *
    from ingen_fab.python_libs.pyspark.lakehouse_utils import lakehouse_utils
    from ingen_fab.python_libs.pyspark.ddl_utils import ddl_utils
    from ingen_fab.python_libs.pyspark.notebook_utils_abstraction import NotebookUtilsFactory
    from ingen_fab.python_libs.pyspark.synthetic_data_utils import PySparkSyntheticDataGenerator, PySparkDatasetBuilder
    from ingen_fab.python_libs.pyspark.incremental_synthetic_data_utils import IncrementalSyntheticDataGenerator
    notebookutils = NotebookUtilsFactory.create_instance() 
else:
    files_to_load = [
        "ingen_fab/python_libs/common/config_utils.py",
        "ingen_fab/python_libs/pyspark/lakehouse_utils.py",
        "ingen_fab/python_libs/pyspark/ddl_utils.py",
        "ingen_fab/python_libs/pyspark/notebook_utils_abstraction.py",
        "ingen_fab/python_libs/pyspark/synthetic_data_utils.py",
        "ingen_fab/python_libs/pyspark/incremental_synthetic_data_utils.py"
    ]

    load_python_modules_from_path(mount_path, files_to_load)

{{macros.python_cell_with_heading("## âš™ï¸ Configuration Settings")}}

# Incremental Dataset Configuration
dataset_config = {{dataset_config | tojson | replace('null', 'None') | replace('true', 'True') | replace('false', 'False')}}
generation_mode = "{{generation_mode}}"
generation_date = "{{generation_date}}"
path_format = "{{path_format}}"  # "nested" or "flat"
state_management = {{state_management | string | lower | replace('false', 'False') | replace('true', 'True')}}

# Parse generation date
from datetime import datetime, date
generation_date_obj = datetime.strptime(generation_date, "%Y-%m-%d").date()

# Incremental configuration
incremental_config = {{incremental_config | tojson | replace('null', 'None') | replace('true', 'True') | replace('false', 'False')}}
table_configs = {{table_configs | tojson | replace('null', 'None') | replace('true', 'True') | replace('false', 'False')}}

# variableLibraryInjectionStart: var_lib
# variableLibraryInjectionEnd: var_lib

{{macros.python_cell_with_heading("## ğŸ†• Initialize Components")}}

# Get configurations
configs: ConfigsObject = get_configs_as_object()

# Initialize lakehouse utils first (this will create/get the Spark session)
target_lakehouse_id = get_config_value("{{target_lakehouse_config_prefix | default('config')}}_lakehouse_id")
target_workspace_id = get_config_value("{{target_lakehouse_config_prefix | default('config')}}_workspace_id")

lh_utils = lakehouse_utils(
    target_workspace_id=target_workspace_id,
    target_lakehouse_id=target_lakehouse_id,
    spark=spark
)

# Initialize incremental synthetic data generator
incremental_generator = IncrementalSyntheticDataGenerator(
    lakehouse_utils_instance=lh_utils,
    seed=incremental_config.get('seed_value'),
    state_table_name=incremental_config.get('state_table_name', 'synthetic_data_state')
)

{{macros.python_cell_with_heading("## ğŸ“… Incremental Data Generation")}}

print(f"ğŸ² Generating incremental synthetic data for dataset: {dataset_config['dataset_id']}")
print(f"ğŸ“… Generation date: {generation_date}")
print(f"ğŸ”§ Generation mode: {generation_mode}")
print(f"ğŸ“ Path format: {path_format}")
print(f"ğŸ”„ State management: {state_management}")

# Display table configuration summary
print("\nğŸ“‹ Table Configuration Summary:")
for table_name, table_config in table_configs.items():
    table_type = table_config.get('type', 'incremental')
    frequency = table_config.get('frequency', 'daily')
    
    if table_type == 'snapshot':
        base_rows = table_config.get('base_rows', 'N/A')
        print(f"  ğŸ“Š {table_name}: {table_type} ({frequency}) - Base: {base_rows:,} rows")
    else:
        daily_rows = table_config.get('base_rows_per_day', 'N/A')
        print(f"  ğŸ“ˆ {table_name}: {table_type} ({frequency}) - Daily: {daily_rows:,} rows")

{{macros.python_cell_with_heading("## ğŸš€ Execute Incremental Generation")}}

# Generate the incremental dataset
try:
    results = incremental_generator.generate_incremental_dataset(
        dataset_config=dataset_config,
        generation_date=generation_date,
        path_format=path_format,
        output_mode="parquet"  # Always use parquet for incremental data
    )
    
    print("âœ… Incremental data generation completed successfully!")
    print(f"\nğŸ“Š Generation Results for {generation_date}:")
    print(f"   Total tables processed: {len(results['generated_tables'])}")
    print(f"   Total rows generated: {results['total_rows']:,}")
    
    # Display detailed results per table
    print("\nğŸ“‹ Detailed Results:")
    for table_name, table_result in results['generated_tables'].items():
        rows = table_result['rows']
        table_type = table_result['type']
        file_path = table_result['file_path']
        print(f"  âœ… {table_name} ({table_type}): {rows:,} rows -> {file_path}")
    
    # Display file paths
    if path_format == "nested":
        date_path = generation_date_obj.strftime("%Y/%m/%d")
        print(f"\nğŸ“ Files saved to: Files/synthetic_data/{dataset_config['dataset_id']}/{date_path}/")
    else:
        date_str = generation_date_obj.strftime("%Y%m%d")
        print(f"\nğŸ“ Files saved to: Files/synthetic_data/{dataset_config['dataset_id']}/")
        print(f"   File naming pattern: {date_str}_[table_name].parquet")
    
except Exception as e:
    print(f"âŒ Error during incremental data generation: {str(e)}")
    import traceback
    traceback.print_exc()
    raise

{{macros.python_cell_with_heading("## ğŸ” Data Quality Validation")}}

print("ğŸ” Performing data quality validation...")

# Validate generated files exist and have expected structure
dataset_dir = f"synthetic_data/{dataset_config['dataset_id']}"
validation_results = {}

for table_name, table_result in results['generated_tables'].items():
    file_path = table_result['file_path']
    expected_rows = table_result['rows']
    
    try:
        # Read the file back to validate
        if path_format == "nested":
            full_path = f"{dataset_dir}/{generation_date_obj.strftime('%Y/%m/%d')}/{table_name}"
        else:
            date_str = generation_date_obj.strftime('%Y%m%d')
            full_path = f"{dataset_dir}/{date_str}_{table_name}"
        
        # Attempt to read the parquet file
        validation_df = lh_utils.read_file(full_path, "parquet")
        actual_rows = validation_df.count()
        
        validation_results[table_name] = {
            "expected_rows": expected_rows,
            "actual_rows": actual_rows,
            "validation_passed": expected_rows == actual_rows,
            "file_path": full_path
        }
        
        status = "âœ…" if expected_rows == actual_rows else "âš ï¸"
        print(f"{status} {table_name}: {actual_rows:,} rows (expected: {expected_rows:,})")
        
    except Exception as e:
        validation_results[table_name] = {
            "expected_rows": expected_rows,
            "actual_rows": 0,
            "validation_passed": False,
            "error": str(e),
            "file_path": file_path
        }
        print(f"âŒ {table_name}: Validation failed - {str(e)}")

# Summary
passed_validations = sum(1 for result in validation_results.values() if result.get('validation_passed', False))
total_validations = len(validation_results)

print(f"\nğŸ“Š Validation Summary: {passed_validations}/{total_validations} tables passed validation")

if passed_validations == total_validations:
    print("ğŸ‰ All data quality validations passed!")
else:
    print("âš ï¸ Some validations failed. Please review the results above.")

{{macros.python_cell_with_heading("## ğŸ“ˆ Generation Statistics")}}

print("ğŸ“ˆ Generation Statistics:")
print(f"   Dataset ID: {dataset_config['dataset_id']}")
print(f"   Generation Date: {generation_date}")
print(f"   Total Tables: {len(results['generated_tables'])}")
print(f"   Total Rows: {results['total_rows']:,}")

# Calculate statistics by table type
snapshot_tables = [name for name, config in table_configs.items() if config.get('type') == 'snapshot']
incremental_tables = [name for name, config in table_configs.items() if config.get('type') == 'incremental']

snapshot_rows = sum(
    results['generated_tables'][name]['rows'] 
    for name in snapshot_tables 
    if name in results['generated_tables']
)

incremental_rows = sum(
    results['generated_tables'][name]['rows'] 
    for name in incremental_tables 
    if name in results['generated_tables']
)

print(f"\nğŸ“Š By Table Type:")
if snapshot_tables:
    generated_snapshots = [name for name in snapshot_tables if name in results['generated_tables']]
    print(f"   Snapshot tables: {len(generated_snapshots)}/{len(snapshot_tables)} generated ({snapshot_rows:,} rows)")
    for name in generated_snapshots:
        print(f"     â€¢ {name}: {results['generated_tables'][name]['rows']:,} rows")

if incremental_tables:
    generated_incrementals = [name for name in incremental_tables if name in results['generated_tables']]
    print(f"   Incremental tables: {len(generated_incrementals)}/{len(incremental_tables)} generated ({incremental_rows:,} rows)")
    for name in generated_incrementals:
        print(f"     â€¢ {name}: {results['generated_tables'][name]['rows']:,} rows")

{{macros.python_cell_with_heading("## ğŸ¯ Next Steps")}}

print("ğŸ¯ Next Steps:")
print("1. âœ… Incremental data generation completed")
print("2. ğŸ“ Files are organized by date using the selected path format")
print("3. ğŸ”„ State has been updated for future incremental generations")

if path_format == "nested":
    print("\nğŸ“‚ Directory Structure (Nested):")
    print(f"   Files/synthetic_data/{dataset_config['dataset_id']}/")
    print(f"   â”œâ”€â”€ {generation_date_obj.strftime('%Y')}/")
    print(f"   â”‚   â”œâ”€â”€ {generation_date_obj.strftime('%m')}/")
    print(f"   â”‚   â”‚   â”œâ”€â”€ {generation_date_obj.strftime('%d')}/")
    for table_name in results['generated_tables'].keys():
        print(f"   â”‚   â”‚   â”‚   â”œâ”€â”€ {table_name}.parquet")
else:
    print("\nğŸ“‚ Directory Structure (Flat):")
    print(f"   Files/synthetic_data/{dataset_config['dataset_id']}/")
    date_str = generation_date_obj.strftime('%Y%m%d')
    for table_name in results['generated_tables'].keys():
        print(f"   â”œâ”€â”€ {date_str}_{table_name}.parquet")

print("\nğŸ’¡ To generate data for additional dates:")
print("   â€¢ Run this notebook with different generation_date values")
print("   â€¢ Use the series generation notebook for bulk date ranges")
print("   â€¢ Snapshot tables will only regenerate based on their frequency settings")
print("   â€¢ Incremental tables will generate new data for each date")

print(f"\nğŸ”— Generated files can be found at:")
if results['file_paths']:
    for table_name, file_path in results['file_paths'].items():
        print(f"   â€¢ {table_name}: Files/{file_path}.parquet")
